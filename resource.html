<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬ì†ŒìŠ¤ ê´€ë¦¬</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 20px; }
        h1 { margin-top: 0; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 20px; }
        .tab-nav { display: flex; gap: 4px; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-nav button { background: #f0f0f0; border: 0; padding: 10px 15px; border-radius: 8px 8px 0 0; cursor: pointer; }
        .tab-nav button.active { background: #fff; border: 2px solid #ddd; border-bottom: 2px solid #fff; font-weight: bold; transform: translateY(2px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .resource-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .resource-card { background: #fafafa; border: 1px solid #ddd; border-radius: 8px; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
        .resource-card h3 { margin: 0; }
        .field { display: flex; gap: 4px; }
        .field input { border: 1px solid #ccc; border-radius: 4px; padding: 6px; }
        .field input.key { flex: 1; }
        .field input.value { flex: 2; }
        .field button { background: #ffeded; color: #c00; border: 1px solid #fcc; padding: 0 6px; font-size: 12px; border-radius: 4px; }
        .card-actions { display: flex; gap: 8px; margin-top: 8px; }
        .card-actions button { font-size: 12px; padding: 4px 8px; }
        .top-actions { display: flex; justify-content: space-between; margin-bottom: 10px; }
        button { background: #007aff; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
        button.sub { background: #6c757d; }
        button.save { background: #28a745; position: fixed; bottom: 20px; right: 20px; z-index: 100; padding: 15px 20px; font-size: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="novelTitle">... (ë¡œë”© ì¤‘) - ë¦¬ì†ŒìŠ¤ ê´€ë¦¬</h1>
        <a id="backToNovel" href="#">â† ì§‘í•„ì‹¤ë¡œ ëŒì•„ê°€ê¸°</a>

        <div class="tab-nav">
            <button class="tab-btn active" data-tab="tab-characters">ë“±ì¥ì¸ë¬¼</button>
            <button class="tab-btn" data-tab="tab-places">ë°°ê²½/ì¥ì†Œ</button>
            <button class="tab-btn" data-tab="tab-terms">ê³ ìœ  ìš©ì–´</button>
            <button class="tab-btn" data-tab="tab-notes">ì´ˆê¸° ë©”ëª¨</button>
        </div>

        <div id="tab-characters" class="tab-content active">
            <div class="top-actions">
                <button id="addCharacter" class="sub">â• ë“±ì¥ì¸ë¬¼ ì¶”ê°€</button>
            </div>
            <div id="characters-grid" class="resource-grid"></div>
        </div>

        <div id="tab-places" class="tab-content">
            <div class="top-actions">
                <button id="addPlace" class="sub">â• ë°°ê²½/ì¥ì†Œ ì¶”ê°€</button>
            </div>
            <div id="places-grid" class="resource-grid"></div>
        </div>

        <div id="tab-terms" class="tab-content">
            <div class="top-actions">
                <button id="addTerm" class="sub">â• ê³ ìœ  ìš©ì–´ ì¶”ê°€</button>
            </div>
            <div id="terms-grid" class="resource-grid"></div>
        </div>

        <div id="tab-notes" class="tab-content">
            <textarea id="notes-content" rows="15" style="width: 100%;"></textarea>
        </div>
    </div>

    <button id="saveAll" class="save">ğŸ’¾ ì „ì²´ ì €ì¥</button>

    <script type="module">
        import { showToast, confirmModal } from './public/ui-utils.js';

        const LS_KEY = 'novels';
        const params = new URLSearchParams(window.location.search);
        const novelId = params.get('id');

        // ë°ì´í„° ë¡œë“œ
        function loadNovels() { try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; } }
        function saveNovels(arr) { localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
        let novels = loadNovels();
        let novel = novels.find(n => n.id === novelId);

        if (!novel) {
            document.body.innerHTML = '<h1>ì†Œì„¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h1><a href="index.html">ëª©ë¡ìœ¼ë¡œ</a>';
            throw new Error("ì†Œì„¤ ì—†ìŒ");
        }

        // ë§ˆìŠ¤í„° ë¦¬ì†ŒìŠ¤ ë³´ì¥ (ì—†ìœ¼ë©´ ìƒì„±)
        if (!novel.resources) {
            novel.resources = { characters: [], places: [], terms: [], notes: "" };
        }
        if (!novel.resources.characters) novel.resources.characters = [];
        if (!novel.resources.places) novel.resources.places = [];
        if (!novel.resources.terms) novel.resources.terms = [];

        // --- ë Œë”ë§ ---
        document.getElementById('novelTitle').textContent = `${novel.title}`;
        document.getElementById('backToNovel').href = `novel.html?id=${novelId}&ep=1`; // TODO: ë§ˆì§€ë§‰ íšŒì°¨ë¡œ ì´ë™

        // íƒ­ ë Œë”ë§
        function renderAll() {
            renderGrid('characters', novel.resources.characters);
            renderGrid('places', novel.resources.places);
            renderGrid('terms', novel.resources.terms);
            document.getElementById('notes-content').value = novel.resources.notes || "";
        }

        /**
         * ë¦¬ì†ŒìŠ¤ ì¹´ë“œ ìƒì„± (í•µì‹¬ ë¡œì§)
         * @param {string} type - 'characters', 'places', 'terms'
         * @param {object} item - ë¦¬ì†ŒìŠ¤ ê°ì²´ (ì˜ˆ: { name: "A", age: 18, ... })
         * @param {number} index - ë°°ì—´ ì¸ë±ìŠ¤
         */
        function createResourceCard(type, item, index) {
            const card = document.createElement('div');
            card.className = 'resource-card';
            card.dataset.index = index;

            const fieldsHtml = Object.entries(item).map(([key, value]) => `
                <div class="field">
                    <input class="key" value="${key}" placeholder="í•„ë“œëª…">
                    <input class="value" value="${value}" placeholder="ê°’">
                    <button class="del-field">Ã—</button>
                </div>
            `).join('');

            card.innerHTML = `
                ${fieldsHtml}
                <div class="card-actions">
                    <button class="add-field">â• í•„ë“œ ì¶”ê°€</button>
                    <button class="del-card" style="background: #ffeded; color: #c00; border: 1px solid #fcc;">ğŸ—‘ï¸ ì¹´ë“œ ì‚­ì œ</button>
                </div>
            `;
            return card;
        }

        /**
         * ê·¸ë¦¬ë“œ ë Œë”ë§
         * @param {string} type - 'characters', 'places', 'terms'
         * @param {Array} data - ë¦¬ì†ŒìŠ¤ ê°ì²´ ë°°ì—´
         */
        function renderGrid(type, data) {
            const gridEl = document.getElementById(`${type}-grid`);
            gridEl.innerHTML = '';
            data.forEach((item, index) => {
                gridEl.appendChild(createResourceCard(type, item, index));
            });
        }

        // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
        
        // íƒ­ ì „í™˜
        const tabNav = document.querySelector('.tab-nav');
        const tabContents = document.querySelectorAll('.tab-content');
        tabNav.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const tabId = e.target.dataset.tab;
            
            tabNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            tabContents.forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        });

        // ë¦¬ì†ŒìŠ¤ ì¶”ê°€ ë²„íŠ¼
        document.getElementById('addCharacter').addEventListener('click', () => {
            novel.resources.characters.push({ ì´ë¦„: "ìƒˆ ìºë¦­í„°", ì„¤ì •: "..." });
            renderGrid('characters', novel.resources.characters);
        });
        document.getElementById('addPlace').addEventListener('click', () => {
            novel.resources.places.push({ ì¥ì†Œëª…: "ìƒˆ ì¥ì†Œ", ì„¤ì •: "..." });
            renderGrid('places', novel.resources.places);
        });
        document.getElementById('addTerm').addEventListener('click', () => {
            novel.resources.terms.push({ ìš©ì–´: "ìƒˆ ìš©ì–´", ì˜ë¯¸: "..." });
            renderGrid('terms', novel.resources.terms);
        });

        // ì¹´ë“œ ë‚´ë¶€ ì´ë²¤íŠ¸ (í•„ë“œ ì¶”ê°€/ì‚­ì œ, ì¹´ë“œ ì‚­ì œ) - ì´ë²¤íŠ¸ ìœ„ì„
        document.querySelector('.container').addEventListener('click', (e) => {
            const card = e.target.closest('.resource-card');
            if (!card) return;

            // í•„ë“œ ì¶”ê°€
            if (e.target.classList.contains('add-field')) {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'field';
                fieldDiv.innerHTML = `
                    <input class="key" value="" placeholder="í•„ë“œëª…">
                    <input class="value" value="" placeholder="ê°’">
                    <button class="del-field">Ã—</button>
                `;
                // 'ì¹´ë“œ ì‚­ì œ' ë²„íŠ¼ ìœ„ì— ì‚½ì…
                e.target.closest('.card-actions').before(fieldDiv);
            }

            // í•„ë“œ ì‚­ì œ
            if (e.target.classList.contains('del-field')) {
                e.target.closest('.field').remove();
            }

            // ì¹´ë“œ ì‚­ì œ
            if (e.target.classList.contains('del-card')) {
                confirmModal('ì´ ë¦¬ì†ŒìŠ¤ ì¹´ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
                    const index = parseInt(card.dataset.index, 10);
                    const type = card.closest('.tab-content').id.split('-')[1]; // 'characters', 'places', 'terms'
                    novel.resources[type].splice(index, 1);
                    renderGrid(type, novel.resources[type]);
                    showToast('ì¹´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                });
            }
        });

        // [í•µì‹¬] ì „ì²´ ì €ì¥
        document.getElementById('saveAll').addEventListener('click', () => {
            try {
                // ê° íƒ­ì˜ UIì—ì„œ ë°ì´í„°ë¥¼ ì½ì–´ ê°ì²´ë¡œ ì—­ë³€í™˜
                const types = ['characters', 'places', 'terms'];
                types.forEach(type => {
                    const gridEl = document.getElementById(`${type}-grid`);
                    const newResourceArray = [];
                    gridEl.querySelectorAll('.resource-card').forEach(card => {
                        const newResourceItem = {};
                        card.querySelectorAll('.field').forEach(field => {
                            const key = field.querySelector('.key').value.trim();
                            const value = field.querySelector('.value').value.trim();
                            if (key) { // í‚¤ê°€ ìˆëŠ” í•„ë“œë§Œ ì €ì¥
                                newResourceItem[key] = value;
                            }
                        });
                        newResourceArray.push(newResourceItem);
                    });
                    novel.resources[type] = newResourceArray;
                });

                // ë©”ëª¨ ì €ì¥
                novel.resources.notes = document.getElementById('notes-content').value;
                
                // ì†Œì„¤ ì—…ë°ì´íŠ¸ ì‹œê°„ ê°±ì‹ 
                novel.updatedAt = Date.now();

                // localStorageì— ì €ì¥
                const novelIndex = novels.findIndex(n => n.id === novelId);
                novels[novelIndex] = novel;
                saveNovels(novels);

                showToast('ë¦¬ì†ŒìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                renderAll(); // ì €ì¥ í›„ ë‹¤ì‹œ ë Œë”ë§ (ì¸ë±ìŠ¤ ë“± ì •ë¦¬)

            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                showToast(`ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            }
        });

        // ì´ˆê¸° ë¡œë“œ
        renderAll();
    </script>
</body>
</html>
