-----

## 🚀 프로젝트 '웹소설 생성기' Vercel 아키텍처 가이드라인

### 1\. 📂 공통 및 프로젝트 관리 규칙

  * **파일 분리:** 유지/보수를 위해 파일을 기능별로 분리합니다. 코드의 줄 수가 한 파일당 1000줄을 넘지 않도록 노력하며, 가급적 500줄 이하를 유지합니다. (**Vercel의 서버리스 함수는 이 원칙에 완벽히 부합합니다.**)
  * **주석 (파일 경로):** 모든 `.js`, `.html`, `.css` 파일의 첫 번째 줄에는 주석으로 파일의 전체 경로와 이름을 명시합니다. (예: `// /api/generate.js`)
  * **주석 (TODO):** `TODO` 주석 작성 시, 단순히 '구현 예정'이 아닌, **구현할 로직을 자연어로 상세히 설명**합니다. 논리적 오류나 미해결 부분에도 `TODO`를 남깁니다.
  * **언어:** 모든 주석, UI 텍스트, 로그, 응답 메시지는 **한국어**로 통일합니다.
  * **코드 재사용:** 반복적으로 쓰이는 기능(예: 유틸리티 함수)은 별도 모듈로 분리하여 여러 곳에서 `import`하여 사용할 수 있도록 설계합니다.
  * **문서 충돌:** `README.md`와 실제 코드가 충돌할 시, **항상 최신 코드를 우선**으로 판단합니다.
  * **타임스탬프:** `createdAt`, `updatedAt` 등 모든 시간 관련 필드는 **Firestore 타임스탬프 또는 ISO 8601 문자열**로 형식을 통일합니다. (데이터 처리 방식에 따라 선택)

-----

### 2\. 🔒 백엔드 및 아키텍처 규칙 (Vercel로 강화)

  * **호스팅 및 배포:**
      * 호스팅 제공업체는 **Vercel**을 사용합니다.
      * 배포는 GitHub Actions가 아닌, **Vercel의 내장 GitHub 연동 기능**을 사용합니다. (`main` 브랜치 `push` 시 자동 배포)
  * **백엔드 런타임:**
      * Firebase v2 함수 대신, \*\*Vercel 서버리스 함수 (Node.js 런타임)\*\*를 사용합니다.
      * 모든 백엔드 로직은 **`/api` 폴더** 안에 위치시킵니다. (예: `/api/generate.js`, `/api/user.js`)
  * **백엔드 리전 (중요):**
      * Firebase의 `asia-northeast3` 대신, \*\*Vercel의 `icn1` (서울/인천 리전)\*\*을 기본 리전으로 설정하여 응답 속도를 최적화합니다.
      * **적용 방법:** 프로젝트 루트에 `vercel.json` 파일을 생성하고 다음 코드를 추가합니다.
        ```json
        {
          "regions": ["icn1"]
        }
        ```
  * **인증 (매우 중요):**
      * Google 로그인 대신, 우리가 논의한 **"경비실 문 열쇠" (개인용 Secret Key) 인증**을 사용합니다.
      * 모든 `/api` 요청은 프론트엔드에서 `x-my-secret-key` (혹은 유사한 이름) 헤더를 포함해야 합니다.
      * 모든 서버리스 함수는 **가장 먼저** 이 헤더의 값을 `process.env.MY_SECRET_KEY`와 비교하여, **일치하지 않으면 즉시 401 Unauthorized 에러를 반환**합니다.
  * **API 키 보안:**
      * `GEMINI_API_KEY`, `NOVELAI_API_KEY` 등 모든 외부 API 키는 **절대** 프론트엔드 코드에 포함시키지 않습니다.
      * 모든 키는 \*\*Vercel 대시보드의 "Environment Variables"\*\*에만 저장하며, 서버리스 함수 내에서 `process.env`를 통해서만 접근합니다.
  * **AI 모델 처리:**
      * **NovelAI**: 항상 **최신/최상 모델** 사용 (환경변수 `NOVELAI_MODEL`로 관리, 기본값: `glm-4.6`)
      * **모델별 역할**:
        - SKETCH (스케치/간단 질의): `gemini-2.5-flash-lite`
        - J_DRAFT/J_POLISH (본문 초안/다듬기): `NovelAI 최신 모델` - **일본어**
        - TRANSLATE_KO (번역): `gemini-2.5-pro` - 일본어 → 한국어
      * **재시도 로직**: 429/5xx 오류 시 지수 백오프 (1s → 2s → 4s, 최대 3회)
      * AI가 생성할 필요 없는 고정 필드(예: `id`, `createdAt`, `authorId`)는 **반드시 서버리스 함수 내에서** 처리하여 JSON에 추가합니다.
      * 모든 AI 생성 요청에 **안전 필터(Safety Settings)** 적용합니다.
  * **데이터베이스 (Firestore 연동 시):**
      * **만약 Vercel 함수에서 Firestore DB를 연동해 사용한다면**, Firestore 트랜잭션 규칙(**"all reads before all writes"**)을 **동일하게 준수**해야 합니다. (이는 Firestore 고유의 규칙이므로 플랫폼과 무관하게 적용됩니다.)
  * **환경 변수:**
      * Vercel 대시보드의 "Environment Variables"에 다음 변수들을 설정해야 합니다:
        - `MY_SECRET_KEY`: 개인용 인증 키
        - `GEMINI_API_KEY`: Google Gemini API 키
        - `NOVELAI_API_KEY`: NovelAI API 키
        - `NOVELAI_MODEL`: NovelAI 모델명 (기본값: `glm-4.6`, 최신 모델로 주기적 업데이트)
        - `NOVELAI_MAX_LENGTH`: NovelAI 최대 생성 길이 (기본값: `4000`, 3000-4000자 목표)

-----

### 3\. 🎨 프론트엔드 및 UI/UX 규칙

  * **로직과 디자인:**
      * 프론트엔드 로직(JavaScript)은 상세하게 구현하되, CSS/디자인은 기초적인 골격만 잡습니다.
      * 복잡한 디자인이 필요한 부분은 코드 대신, \*\*주석으로 "어떻게 디자인되어야 하며 어떤 방식으로 작동해야 하는지"\*\*를 상세히 기록합니다.
  * **모바일 대응:**
      * 모든 UI는 **모바일 환경**을 우선적으로 고려하여 반응형으로 설계합니다.
  * **[2025-10-19] 지침 (모달 및 Z-Index):**
      * 여러 모달이나 토스트 메시지를 띄울 경우, **`z-index`를 유의하여 정하며, 절대 같은 인덱스로 설정하지 않습니다.**
      * **토스트 메시지(알림)가 항상 최상위**에 오도록 `z-index`를 가장 높게 설정합니다.
      * 단순 알림(예: '저장됨')은 토스트로, 사용자의 확인이 필요한 메시지(예: '삭제하시겠습니까?')는 **모달**로 띄웁니다.
  * **[2025-10-19] 지침 (버튼 상태):**
      * API 호출 등 비동기 함수를 실행하는 버튼은, **클릭 즉시 `disabled` (비활성화) 처리**하고 **"\~하는 중..."** 텍스트와 스피너를 표시합니다.
      * 요청이 완료(성공 또는 실패)되면 **반드시 버튼을 다시 활성화**합니다.
  * **데이터 로딩:**
      * 페이지 로드 시 필요한 데이터는 **해당 페이지에 필요한 최소한의 데이터만** 서버리스 함수를 통해 불러오도록 효율적으로 설계합니다.
  * **디자인 통일성:**
      * 아이콘은 이모티콘(emoji)이 아닌, 일관된 \*\*아이콘 라이브러리(예: Heroicons, Material Icons)\*\*를 사용하도록 지시합니다.
      * **부드러운 애니메이션(transitions)**, 모던한 디자인, 높은 사용 편의성을 지향합니다.
      * 글자와 배경의 **명암 대비**를 확실하게 하여 **가시성과 가독성**을 높입니다.
  * **사용자 경험 (UX):**
      * 기능 구현 전, 가상의 \*\*텍스트 시뮬레이션(시나리오)\*\*을 통해 사용 흐름에 불편함이 없는지 검토합니다.
