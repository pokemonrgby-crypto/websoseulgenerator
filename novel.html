<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ì§‘í•„ì‹¤ (V6.2 - ë¦¬ì†ŒìŠ¤ ì£¼ì…)</title>
  <style>
    body { font-family:-apple-system,sans-serif; background:#f0f2f5; }
    .editor-layout{ display:grid; grid-template-columns: 1fr 360px; gap:20px; padding:20px; max-width:1600px; margin:0 auto; height:calc(100vh - 40px); }
    .main-content{ background:#fff; border-radius:12px; padding:20px; display:flex; flex-direction:column; gap:12px; }
    .side{ background:#fff; border-radius:12px; padding:20px; display:flex; flex-direction:column; gap:16px; overflow-y: auto; }
    h2 { margin:0 0 4px 0; }
    textarea, input { width:100%; border:1px solid #ddd; border-radius:8px; padding:10px; font-family:inherit; box-sizing: border-box; }
    button { background:#007aff; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button:disabled { background: #999; }
    button.sub-ai { background:#6c757d; }
    button.resource { background: #e6f7ff; color: #0056b3; border: 1px solid #b3e0ff; }
    pre { white-space:pre-wrap; word-break:break-word; }
    .blocks p { margin:8px 0; line-height:1.6; }

    /* ë¦¬ì†ŒìŠ¤ ì£¼ì…ê¸° ìŠ¤íƒ€ì¼ */
    #resource-injector { border:1px solid #ddd; border-radius:12px; padding:12px; }
    #resource-injector legend { font-weight: bold; }
    .resource-list { max-height: 200px; overflow-y: auto; padding: 5px; background: #f9f9f9; border-radius: 6px; }
    .resource-list label { display: block; padding: 4px; border-radius: 4px; cursor: pointer; }
    .resource-list label:hover { background: #eee; }
    .resource-list input { margin-right: 8px; }
  </style>
</head>
<body>

<div id="keybar" style="position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #eee;padding:10px 12px;margin:-20px -20px 10px -20px;display:flex;gap:8px;align-items:center;">
  <strong>ğŸ”‘ ê²½ë¹„ì‹¤ í‚¤</strong>
  <input id="secretKeyInput" placeholder="MY_SECRET_KEY" style="flex:1;max-width:360px;padding:8px;border:1px solid #ddd;border-radius:8px;">
  <button id="saveSecretKeyButton" style="padding:8px 12px;border:0;border-radius:8px;background:#007aff;color:#fff;">ì €ì¥</button>
  <button id="deleteSecretKeyButton" style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#fff;">ì‚­ì œ</button>
  <span id="keyStatus" style="margin-left:8px;color:#666;font-size:12px;"></span>
</div>
<script>
(function(){
  const $=id=>document.getElementById(id);
  const input=$('secretKeyInput'), status=$('keyStatus');
  const v=localStorage.getItem('MY_SECRET_KEY')||'';
  input.value=v; status.textContent=v?'ì €ì¥ë¨':'ë¯¸ì €ì¥';
  $('saveSecretKeyButton').onclick=()=>{ const t=input.value.trim(); if(!t) return alert('ê°’ì´ ë¹„ì–´ìˆì–´.'); localStorage.setItem('MY_SECRET_KEY',t); status.textContent='ì €ì¥ë¨'; alert('í‚¤ ì €ì¥ ì™„ë£Œ!'); };
  $('deleteSecretKeyButton').onclick=()=>{ localStorage.removeItem('MY_SECRET_KEY'); input.value=''; status.textContent='ë¯¸ì €ì¥'; alert('í‚¤ ì‚­ì œ ì™„ë£Œ!'); };
})();
</script>
<div class="editor-layout">
  <div class="main-content">
    <h2 id="episodeTitle">ì§‘í•„</h2>
    <label>í•µì‹¬ í”„ë¡¬í”„íŠ¸(ê¸°íš/ë³¸ì‘ì„±/ë‹¤ë“¬ê¸°/ë²ˆì—­ì— ê³µí†µìœ¼ë¡œ ì‚¬ìš©ë  ì…ë ¥)</label>
    <textarea id="sceneRequest" rows="8" placeholder="ì—¬ê¸°ì— ìš”êµ¬ì‚¬í•­/ì´ì–´ì“°ê¸° ë‚´ìš© ë“±ì„ ì ì–´ì¤˜. (ë³¸ì‘ì„±ì€ ì¼ë³¸ì–´ë¡œ ê²°ê³¼ê°€ ë‚˜ì™€)"></textarea>

    <div>
      <select id="pipelineStage" style="margin-right:8px;">
        <option value="SKETCH">ê¸°íš (Flash-lite)</option>
        <option value="J_DRAFT">ë³¸ì‘ì„± (NAI/ì¼ë³¸ì–´/3000-4000ì)</option>
        <option value="J_POLISH">ë‹¤ë“¬ê¸° (NAI/ì¼ë³¸ì–´)</option>
        <option value="TRANSLATE_KO">ë²ˆì—­ (Gemini 2.5 Pro/ì¼â†’í•œ)</option>
      </select>
      <button id="generateSceneButton">âœ¨ ì‹¤í–‰</button>
      <button id="copyJapaneseButton" class="sub-ai" style="margin-left:8px;">ğŸ§· ì›ë¬¸(ì¼ë³¸ì–´) ë³µì‚¬</button>
      <button id="saveContentButton" class="sub-ai" style="margin-left:8px;">ğŸ’¾ ë³¸ë¬¸ ì €ì¥</button>
    </div>

    <div class="blocks" id="novel-blocks" style="flex: 1; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px;"></div>
    <pre id="sceneResult" style="background:#f6f6f6;padding:8px;border-radius:8px;"></pre>
  </div>

  <div class="side">
    <fieldset id="resource-injector">
      <legend>ë¦¬ì†ŒìŠ¤ ì£¼ì…</legend>
      <button id="editResourcesButton" class="resource" style="width: 100%; margin-bottom: 12px;">ğŸ“š ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™</button>
      
      <strong>ë“±ì¥ì¸ë¬¼</strong>
      <div id="characters-list" class="resource-list"></div>
      <br>
      <strong>ë°°ê²½/ì¥ì†Œ</strong>
      <div id="places-list" class="resource-list"></div>
      <br>
      <strong>ê³ ìœ  ìš©ì–´</strong>
      <div id="terms-list" class="resource-list"></div>
    </fieldset>

    <fieldset style="border:1px solid #ddd;border-radius:12px;padding:12px;">
      <legend>í¸ì˜ í”„ë¡¬í”„íŠ¸ (Flash-lite)</legend>
      <textarea id="proxyPrompt" rows="4" placeholder="ë¹ ë¥¸ ì§ˆë¬¸/ìš”ì•½ ë“±"></textarea>
      <button id="proxyButton" class="sub-ai">ë³´ë‚´ê¸°</button>
      <pre id="proxyResult" style="background:#f6f6f6;padding:8px;border-radius:8px;"></pre>
    </fieldset>

    </div>
</div>

<script type="module">
  // ê³µìš© ìœ í‹¸ë¦¬í‹° ì„í¬íŠ¸
  import { showToast, toggleButtonLoading } from './public/ui-utils.js';

  const params=new URLSearchParams(location.search);
  const novelId=params.get('id'); const episodeNum=Number(params.get('ep')||1);
  const secretKey=localStorage.getItem('MY_SECRET_KEY');

  const LS_KEY='novels';
  const $=id=>document.getElementById(id);

  function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
  function save(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
  function getNovel(){ return load().find(n=>n.id===novelId); }
  function getEpisode(n){ return (n.episodes||[]).find(e=>e.no===episodeNum); }

  const novel = getNovel();
  if (!novel) {
      document.body.innerHTML = '<h1>ì†Œì„¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h1><a href="index.html">ëª©ë¡ìœ¼ë¡œ</a>';
      throw new Error("ì†Œì„¤ ì—†ìŒ");
  }
  const episode = getEpisode(novel);

  // ì œëª© ì„¸íŒ…
  (function initTitle(){
    $('episodeTitle').textContent=`${novel.title} - ${episodeNum}í™” ì§‘í•„ ì¤‘`;
  })();

  // [ì‹ ê·œ] ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ í˜ì´ì§€ ì´ë™ ë²„íŠ¼
  $('editResourcesButton').onclick = () => location.href = `resource.html?id=${novelId}`;

  // [ì‹ ê·œ] ë¦¬ì†ŒìŠ¤ ì£¼ì…ê¸° ë Œë”ë§
  let masterResources = novel.resources || { characters: [], places: [], terms: [] };
  // TODO: íšŒì°¨ ìŠ¤ëƒ…ìƒ· ë¦¬ì†ŒìŠ¤(episode.resources)ì™€ ë¹„êµí•˜ì—¬ UIì— í‘œì‹œí•´ì•¼ í•¨ (ê·œì¹™ #11)
  // í˜„ì¬ëŠ” ë§ˆìŠ¤í„° ë¦¬ì†ŒìŠ¤ë§Œ í‘œì‹œ (ë‹¨ìˆœí™”)

  /**
   * ë¦¬ì†ŒìŠ¤ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
   * @param {string} type - 'characters', 'places', 'terms'
   * @param {Array} data - ë¦¬ì†ŒìŠ¤ ê°ì²´ ë°°ì—´
   */
  function renderResourceList(type, data) {
    const listEl = $(`${type}-list`);
    listEl.innerHTML = '';
    if (!data || data.length === 0) {
      listEl.innerHTML = '<span>(ë¦¬ì†ŒìŠ¤ ì—†ìŒ)</span>';
      return;
    }
    data.forEach((item, index) => {
      // ì¹´ë“œì— í‘œì‹œë  ì´ë¦„ ì°¾ê¸° (name, ì´ë¦„, ì¥ì†Œëª…, ìš©ì–´ ë“±)
      const displayName = item.name || item.ì´ë¦„ || item.ì¥ì†Œëª… || item.ìš©ì–´ || `í•­ëª© ${index + 1}`;
      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" class="resource-check" data-type="${type}" data-index="${index}" checked> ${displayName}`;
      listEl.appendChild(label);
    });
  }

  (function loadResources() {
    renderResourceList('characters', masterResources.characters);
    renderResourceList('places', masterResources.places);
    renderResourceList('terms', masterResources.terms);
  })();

  // [ì‹ ê·œ] ì²´í¬ëœ ë¦¬ì†ŒìŠ¤ ì§ë ¬í™”
  function getFormattedResources() {
    let resourceText = "";
    const checkedItems = document.querySelectorAll('.resource-check:checked');
    if (checkedItems.length === 0) return "";

    const grouped = { characters: [], places: [], terms: [] };

    checkedItems.forEach(check => {
      const type = check.dataset.type;
      const index = parseInt(check.dataset.index, 10);
      grouped[type].push(masterResources[type][index]);
    });

    if (grouped.characters.length > 0) {
      resourceText += "ã€ë“±ì¥ì¸ë¬¼ã€‘\n" + grouped.characters.map(item => JSON.stringify(item)).join('\n') + "\n\n";
    }
    if (grouped.places.length > 0) {
      resourceText += "ã€ë°°ê²½/ì¥ì†Œã€‘\n" + grouped.places.map(item => JSON.stringify(item)).join('\n') + "\n\n";
    }
    if (grouped.terms.length > 0) {
      resourceText += "ã€ê³ ìœ  ìš©ì–´ã€‘\n" + grouped.terms.map(item => JSON.stringify(item)).join('\n') + "\n\n";
    }
    
    return resourceText.trim();
  }


  // íŒŒì´í”„ë¼ì¸ & ëª¨ë¸ ë§¤í•‘
  let lastJapaneseDraft = "";
  const MODEL_FOR = {
    SKETCH: 'gemini-2.5-flash-lite',  // ìŠ¤ì¼€ì¹˜ ê°œìš”
    J_DRAFT: 'novelai',                // ë³¸ë¬¸ ì´ˆì•ˆ (ì¼ë³¸ì–´) - NovelAI ìµœì‹  ëª¨ë¸
    J_POLISH: 'novelai',               // ë‹¤ë“¬ê¸° (ì¼ë³¸ì–´) - NovelAI ìµœì‹  ëª¨ë¸
    TRANSLATE_KO: 'gemini-2.5-pro'     // ë²ˆì—­ (ì¼â†’í•œ) - Gemini 2.5 Pro
  };

  /**
   * [ìˆ˜ì •] í”„ë¡¬í”„íŠ¸ ë¹Œë” (ë¦¬ì†ŒìŠ¤ í…ìŠ¤íŠ¸ ì¶”ê°€)
   * @param {string} stage 
   * @param {string} userText 
   * @param {string} resourceText 
   */
  function buildPrompt(stage, userText, resourceText = ""){
    const resourceBlock = resourceText ? `ã€ì°¸ê³  ë¦¬ì†ŒìŠ¤ã€‘\n${resourceText}\n\n` : "";

    switch(stage){
      case 'SKETCH':
        // ìŠ¤ì¼€ì¹˜: ê°ˆë“±â†’ì „í™˜â†’í›„í­í’ 3ë‹¨ êµ¬ì¡° ê°œìš” ìƒì„±
        return `${resourceBlock}ë„ˆëŠ” ì›¹ì†Œì„¤ ê¸°íš ë³´ì¡°ì•¼. ì•„ë˜ ë¦¬ì†ŒìŠ¤ì™€ ìš”êµ¬ì‚¬í•­ì„ ë°”íƒ•ìœ¼ë¡œ ê°ˆë“±â†’ì „í™˜â†’í›„í­í’ 3ë‹¨ êµ¬ì¡°ë¡œ ì •ë¦¬í•´ì¤˜.
ê° ë‹¨ê³„ë³„ë¡œ 5-8ë¬¸ì¥ì”© ì‘ì„±í•˜ê³ , ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•´:
- ê°œìš” (ì¥ë©´ íë¦„)
- í•µì‹¬ ë„êµ¬/ì†Œí’ˆ
- ê°ì • ë³€í™”
- ë‹¤ìŒ ì¥ë©´ í›…

ìš”êµ¬ì‚¬í•­:
${userText}`;
      case 'J_DRAFT':
        // ë³¸ë¬¸ ì´ˆì•ˆ: ì¼ë³¸ì–´ë¡œ 3000-4000ì ì›¹ì†Œì„¤ ìƒì„±
        return `ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ã¨è¦ä»¶ã«å¾“ã£ã¦ã€æ—¥æœ¬èªã§ã‚¦ã‚§ãƒ–å°èª¬ã®æœ¬æ–‡ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚

${resourceBlock}ã€å¿…é ˆè¦ä»¶ã€‘
- æ–‡å­—æ•°: 3,000ï½4,000å­—ã‚’ç›®æ¨™ã¨ã™ã‚‹
- æ”¹è¡Œ: å¿…ãš \\n ã‚’ä½¿ç”¨ (ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ äº’æ›ì„±)
- æ–‡ä½“: ã‚¦ã‚§ãƒ–å°èª¬ã‚‰ã—ãä¼šè©±ã‚’ä¸­å¿ƒã«ã€æ–‡ã”ã¨ã®æ”¹è¡Œã‚’ç©æ¥µçš„ã«æ´»ç”¨
- åŠ¹æœéŸ³(SFX): ã‚»ãƒªãƒ•ã®å¤–ã®åœ°ã®æ–‡ã§è¡¨è¨˜ (ä¾‹: ã€SFXã€‘ï½ï½)
- å›ºæœ‰åè©ãƒ»å£èª¿: ãƒªã‚½ãƒ¼ã‚¹ã«åŸºã¥ãä¸€è²«æ€§ã‚’ä¿ã¤
- ãƒˆãƒ¼ãƒ³/ì—°ì¶œ: å ´é¢ã®ç›®çš„ã‚’æ˜ç¢ºã«ã€æ„Ÿæƒ…ç·š/è‘›è—¤-è»¢æ›-ä½™éŸ»ã®æµã‚Œã‚’ç¶­æŒ

ã€è¦ä»¶ã€‘
${userText}

ã€ç¦æ­¢äº‹é …ã€‘
- ãƒªã‚½ãƒ¼ã‚¹ã¨çŸ›ç›¾ã™ã‚‹å†…å®¹
- ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒªã‚·ãƒ¼é•å (æš´åŠ›è¡¨ç¾ãƒ»å€‹äººæƒ…å ±ãƒ»å·®åˆ¥è¡¨ç¾ã®ç¦æ­¢)`;
      case 'J_POLISH':
        // ì¼ë³¸ì–´ ë‹¤ë“¬ê¸°: ì˜ë¯¸ ìœ ì§€í•˜ë©° ë¬¸ì¥ ê°œì„ 
        return `${resourceBlock}ë‹¤ìŒ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¸ê³ í•˜ì—¬, ì•„ë˜ì˜ ì¼ë³¸ì–´ ì›¹ì†Œì„¤ ë³¸ë¬¸ì„ ì¶”ê³ (æ¨æ•²)í•´ì£¼ì„¸ìš”.

ã€ì¶”ê³ (æ¨æ•²)ì˜ ë°©ì¹¨ã€‘
- ë¦¬ì†ŒìŠ¤ì™€ ì¼ê´€ì„± ìœ ì§€ (íŠ¹íˆ ë§íˆ¬, ê³ ìœ ëª…ì‚¬)
- ì˜ë¯¸ëŠ” ë°”ê¾¸ì§€ ì•ŠëŠ”ë‹¤
- ì¤‘ë³µë˜ê±°ë‚˜ ë¶ˆí•„ìš”í•œ í‘œí˜„ ì‚­ì œ
- ë¬¸ì¥ì˜ ë¦¬ë“¬ê³¼ í˜¸í¡ ê°œì„ 
- ê¸¸ì´ëŠ” Â±10% ë‚´ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì¡°ì •

ã€ë³¸ë¬¸ã€‘
${userText}`;
      case 'TRANSLATE_KO':
        // ë²ˆì—­: ì¼ë³¸ì–´â†’í•œêµ­ì–´ ìì—°ìŠ¤ëŸ½ê²Œ
        return `${resourceBlock}ë‹¤ìŒ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¸ê³ í•˜ì—¬, ì•„ë˜ì˜ ì¼ë³¸ì–´ ì›¹ì†Œì„¤ ë³¸ë¬¸ì„ ìì—°ìŠ¤ëŸ½ê³  ë¬¸í•™ì ì¸ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜.

ã€ë²ˆì—­ ì›ì¹™ã€‘
- ë§ë§›/í†¤ ìœ ì§€, ê³¼í•œ ì˜ì—­ ê¸ˆì§€
- ë¦¬ì†ŒìŠ¤ì— ëª…ì‹œëœ ê³ ìœ ëª…ì‚¬/ì¸ëª…ì€ ì •í™•íˆ ë²ˆì—­
- ì›¹ì†Œì„¤ë‹µê²Œ ëŒ€í™”ì™€ ì¤„ë°”ê¿ˆ ì‚´ë¦¬ê¸°
- íš¨ê³¼ìŒ(SFX) í‘œê¸° ìœ ì§€

ã€ì¼ë³¸ì–´ ë³¸ë¬¸ã€‘
${userText}`;
      default:
        return userText;
    }
  }

  async function callProxy(model, prompt, secretKey){
    const res = await fetch('/api/generate', {
      method:'POST',
      headers:{'Content-Type':'application/json', 'x-my-secret-key': secretKey},
      body: JSON.stringify({ model, prompt })
    });
    if(!res.ok){ const t=await res.text(); throw new Error(t||'ìš”ì²­ ì‹¤íŒ¨'); }
    return res.json();
  }

  // ì‹¤í–‰ ë²„íŠ¼
  const generateBtn=$('generateSceneButton');
  const sceneResultEl=$('sceneResult');

  generateBtn.addEventListener('click', async ()=>{
    const userText=$('sceneRequest').value;
    if(!secretKey || !userText) return showToast('í‚¤ ë˜ëŠ” ì…ë ¥ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.', 'warning');

    const stage=($('pipelineStage')||{value:'SKETCH'}).value;
    const model=MODEL_FOR[stage];
    
    // [ì‹ ê·œ] ì²´í¬ëœ ë¦¬ì†ŒìŠ¤ ê°€ì ¸ì˜¤ê¸°
    const resourceText = getFormattedResources();
    
    // [ìˆ˜ì •] í”„ë¡¬í”„íŠ¸ ë¹Œë“œ
    const prompt=buildPrompt(stage, userText, resourceText);

    toggleButtonLoading(generateBtn, true, 'ìƒì„± ì¤‘...');
    try{
      const data=await callProxy(model, prompt, secretKey);
      const text=data.text||'';

      // ë³¸ë¬¸ í™”ë©´ì— ì¶”ê°€
      // TODO: ê¸°ì¡´ ë¸”ë¡ì— ì¶”ê°€í•˜ëŠ” ë°©ì‹ ê°œì„  í•„ìš”
      const p=document.createElement('p'); p.textContent=text||' ';
      $('novel-blocks').appendChild(p);

      // ì¼ë³¸ì–´ ë‹¨ê³„ ìºì‹±
      if(stage==='J_DRAFT' || stage==='J_POLISH'){ lastJapaneseDraft=text; }

      sceneResultEl.textContent=`[${data.model}] ì™„ë£Œ`;
      showToast(`${stage} ë‹¨ê³„ ìƒì„± ì™„ë£Œ!`, 'success');
    }catch(e){
      sceneResultEl.textContent=`ì˜¤ë¥˜: ${e.message}`;
      showToast('ì˜¤ë¥˜: ' + e.message, 'error');
    }finally{
      toggleButtonLoading(generateBtn, false, 'âœ¨ ì‹¤í–‰');
    }
  });

  // ì›ë¬¸ ë³µì‚¬
  $('copyJapaneseButton').addEventListener('click', async ()=>{
    if(!lastJapaneseDraft) return showToast('ì•„ì§ ì¼ë³¸ì–´ ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
    await navigator.clipboard.writeText(lastJapaneseDraft);
    showToast('ì¼ë³¸ì–´ ì›ë¬¸ ë³µì‚¬ ì™„ë£Œ!', 'success');
  });

  // ë³¸ë¬¸ ì €ì¥(ë¡œì»¬)
  $('saveContentButton').addEventListener('click', ()=>{
    const arr=load(); const n=arr.find(x=>x.id===novelId); if(!n) return showToast('ì†Œì„¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    const ep=getEpisode(n); if(!ep) return showToast('íšŒì°¨ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    
    const blocks=[...document.querySelectorAll('#novel-blocks p')].map(p=>p.textContent);
    ep.content = blocks.join('\n\n'); // \n\nìœ¼ë¡œ ë¬¸ë‹¨ êµ¬ë¶„ ì €ì¥
    
    ep.updatedAt=Date.now(); n.updatedAt=Date.now(); save(arr);
    showToast('ë³¸ë¬¸ ì €ì¥ ì™„ë£Œ!', 'success');
    
    // TODO: íšŒì°¨ ì €ì¥ ì‹œ ë¦¬ì†ŒìŠ¤ ìŠ¤ëƒ…ìƒ· ì €ì¥ (ê·œì¹™ #13)
    // "ë³€í™”ê°€ ë°œìƒí•œ ë¦¬ì†ŒìŠ¤ë§Œ íšŒì°¨ ë¦¬ì†ŒìŠ¤ë¡œ ìŠ¤ëƒ…ìƒ·"
  });

  // í¸ì˜ í”„ë¡¬í”„íŠ¸(Flash-lite)
  const proxyBtn=document.getElementById('proxyButton');
  const proxyResultEl=document.getElementById('proxyResult');
  proxyBtn.addEventListener('click', async ()=>{
    const prompt=document.getElementById('proxyPrompt').value;
    if(!secretKey || !prompt) return showToast('í‚¤ ë˜ëŠ” í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
    
    toggleButtonLoading(proxyBtn, true, 'ì „ì†¡ ì¤‘...');
    try{
      const data=await callProxy('gemini-2.5-flash-lite', prompt, secretKey);
      proxyResultEl.textContent=data.text||'';
      showToast('ì‘ë‹µ ì™„ë£Œ', 'success');
    }catch(e){
      proxyResultEl.textContent=`ì˜¤ë¥˜: ${e.message}`;
      showToast('ì˜¤ë¥˜ ë°œìƒ: ' + e.message, 'error');
    }finally{
      toggleButtonLoading(proxyBtn, false, 'ë³´ë‚´ê¸°');
    }
  });

  // ê¸°ì¡´ íšŒì°¨ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸°(ìˆìœ¼ë©´)
  (function loadEpisodeContent(){
    if(episode && episode.content){
      // \n\n (ë¹ˆ ì¤„)ì„ ê¸°ì¤€ìœ¼ë¡œ ë¬¸ë‹¨ì„ ë³µì›
      episode.content.split(/\n\s*\n/).forEach(chunk=>{
        const p=document.createElement('p'); p.textContent=chunk || ' '; // ë¹ˆ ì¤„ë„ p íƒœê·¸ë¡œ
        $('novel-blocks').appendChild(p);
      });
    }
    // TODO: íšŒì°¨ ìŠ¤ëƒ…ìƒ·(episode.resources)ì´ ìˆìœ¼ë©´ 'ë³€ê²½ ì „'ìœ¼ë¡œ í‘œì‹œ
  })();
</script>
</body>
</html>
