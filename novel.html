<!-- /novel.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ì§‘í•„ì‹¤ (V6.2)</title>
  <style>
    body { font-family:-apple-system,sans-serif; background:#f0f2f5; }
    .editor-layout{ display:grid; grid-template-columns: 1fr 360px; gap:20px; padding:20px; max-width:1600px; margin:0 auto; height:calc(100vh - 40px); }
    .main-content{ background:#fff; border-radius:12px; padding:20px; display:flex; flex-direction:column; gap:12px; }
    .side{ background:#fff; border-radius:12px; padding:20px; display:flex; flex-direction:column; gap:16px; }
    h2 { margin:0 0 4px 0; }
    textarea, input { width:100%; border:1px solid #ddd; border-radius:8px; padding:10px; font-family:inherit; }
    button { background:#007aff; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button.sub-ai { background:#6c757d; }
    pre { white-space:pre-wrap; word-break:break-word; }
    .blocks p { margin:8px 0; line-height:1.6; }
  </style>
</head>
<body>

<!-- [KEYBAR START] -->
<div id="keybar" style="position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #eee;padding:10px 12px;margin:-20px -20px 10px -20px;display:flex;gap:8px;align-items:center;">
  <strong>ğŸ”‘ ê²½ë¹„ì‹¤ í‚¤</strong>
  <input id="secretKeyInput" placeholder="MY_SECRET_KEY" style="flex:1;max-width:360px;padding:8px;border:1px solid #ddd;border-radius:8px;">
  <button id="saveSecretKeyButton" style="padding:8px 12px;border:0;border-radius:8px;background:#007aff;color:#fff;">ì €ì¥</button>
  <button id="deleteSecretKeyButton" style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#fff;">ì‚­ì œ</button>
  <span id="keyStatus" style="margin-left:8px;color:#666;font-size:12px;"></span>
</div>
<script>
(function(){
  const $=id=>document.getElementById(id);
  const input=$('secretKeyInput'), status=$('keyStatus');
  const v=localStorage.getItem('MY_SECRET_KEY')||'';
  input.value=v; status.textContent=v?'ì €ì¥ë¨':'ë¯¸ì €ì¥';
  $('saveSecretKeyButton').onclick=()=>{ const t=input.value.trim(); if(!t) return alert('ê°’ì´ ë¹„ì–´ìˆì–´.'); localStorage.setItem('MY_SECRET_KEY',t); status.textContent='ì €ì¥ë¨'; alert('í‚¤ ì €ì¥ ì™„ë£Œ!'); };
  $('deleteSecretKeyButton').onclick=()=>{ localStorage.removeItem('MY_SECRET_KEY'); input.value=''; status.textContent='ë¯¸ì €ì¥'; alert('í‚¤ ì‚­ì œ ì™„ë£Œ!'); };
})();
</script>
<!-- [KEYBAR END] -->

<div class="editor-layout">
  <div class="main-content">
    <h2 id="episodeTitle">ì§‘í•„</h2>
    <label>í•µì‹¬ í”„ë¡¬í”„íŠ¸(ê¸°íš/ë³¸ì‘ì„±/ë‹¤ë“¬ê¸°/ë²ˆì—­ì— ê³µí†µìœ¼ë¡œ ì‚¬ìš©ë  ì…ë ¥)</label>
    <textarea id="sceneRequest" rows="8" placeholder="ì—¬ê¸°ì— ìš”êµ¬ì‚¬í•­/ì´ì–´ì“°ê¸° ë‚´ìš© ë“±ì„ ì ì–´ì¤˜. (ë³¸ì‘ì„±ì€ ì¼ë³¸ì–´ë¡œ ê²°ê³¼ê°€ ë‚˜ì™€)"></textarea>

    <div>
      <select id="pipelineStage" style="margin-right:8px;">
        <option value="SKETCH">ê¸°íš (Flash-lite)</option>
        <option value="J_DRAFT">ë³¸ì‘ì„± (NAI/ì¼ë³¸ì–´/3000-4000ì)</option>
        <option value="J_POLISH">ë‹¤ë“¬ê¸° (NAI/ì¼ë³¸ì–´)</option>
        <option value="TRANSLATE_KO">ë²ˆì—­ (Gemini 2.5 Pro/ì¼â†’í•œ)</option>
      </select>
      <button id="generateSceneButton">âœ¨ ì‹¤í–‰</button>
      <button id="copyJapaneseButton" class="sub-ai" style="margin-left:8px;">ğŸ§· ì›ë¬¸(ì¼ë³¸ì–´) ë³µì‚¬</button>
    </div>

    <div class="blocks" id="novel-blocks"></div>
    <pre id="sceneResult" style="background:#f6f6f6;padding:8px;border-radius:8px;"></pre>
  </div>

  <div class="side">
    <fieldset style="border:1px solid #ddd;border-radius:12px;padding:12px;">
      <legend>íšŒì°¨ ë°ì´í„°(ì°¸ê³ /ìˆ˜ì •)</legend>
      <label>ë³€ê²½ ì „(ì°¸ê³ )</label>
      <textarea id="dbBefore" rows="4" readonly>{"name":"A","status":"íŒ” ìˆìŒ"}</textarea>
      <label>ë³€ê²½ í›„(ì €ì¥ ëŒ€ìƒ)</label>
      <textarea id="dbAfter" rows="4">{"name":"A","status":"íŒ” ì—†ìŒ"}</textarea>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button id="saveEpisodeDbButton" class="sub-ai">íšŒì°¨ DB ì €ì¥</button>
        <button id="saveContentButton" class="sub-ai">ë³¸ë¬¸ ì €ì¥</button>
      </div>
    </fieldset>

    <fieldset style="border:1px solid #ddd;border-radius:12px;padding:12px;">
      <legend>í¸ì˜ í”„ë¡¬í”„íŠ¸ (Flash-lite)</legend>
      <textarea id="proxyPrompt" rows="4" placeholder="ë¹ ë¥¸ ì§ˆë¬¸/ìš”ì•½ ë“±"></textarea>
      <button id="proxyButton" class="sub-ai">ë³´ë‚´ê¸°</button>
      <pre id="proxyResult" style="background:#f6f6f6;padding:8px;border-radius:8px;"></pre>
    </fieldset>
  </div>
</div>

<script>
  const params=new URLSearchParams(location.search);
  const novelId=params.get('id'); const episodeNum=Number(params.get('ep')||1);
  const secretKey=localStorage.getItem('MY_SECRET_KEY');

  const LS_KEY='novels';
  const $=id=>document.getElementById(id);

  function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
  function save(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
  function getNovel(){ return load().find(n=>n.id===novelId); }
  function getEpisode(n){ return (n.episodes||[]).find(e=>e.no===episodeNum); }

  // í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜
  function showToast(message, type = 'info', duration = 3000) {
    let container = document.getElementById('toast-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toast-container';
      container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:10px;';
      document.body.appendChild(container);
    }
    const colors = { success: '#28a745', error: '#dc3545', info: '#007aff', warning: '#ffc107' };
    const toast = document.createElement('div');
    toast.style.cssText = `background:${colors[type]||colors.info};color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);font-size:14px;max-width:350px;`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { container.removeChild(toast); if(container.children.length===0) document.body.removeChild(container); }, duration);
  }

  // ì œëª© ì„¸íŒ…
  (function initTitle(){
    $('episodeTitle').textContent=`${novelId} - ${episodeNum}í™” ì§‘í•„ ì¤‘`;
  })();

  // íŒŒì´í”„ë¼ì¸ & ëª¨ë¸ ë§¤í•‘
  let lastJapaneseDraft = "";
  const MODEL_FOR = {
    SKETCH: 'gemini-2.5-flash-lite',  // ìŠ¤ì¼€ì¹˜ ê°œìš”
    J_DRAFT: 'novelai',                // ë³¸ë¬¸ ì´ˆì•ˆ (ì¼ë³¸ì–´) - NovelAI ìµœì‹  ëª¨ë¸
    J_POLISH: 'novelai',               // ë‹¤ë“¬ê¸° (ì¼ë³¸ì–´) - NovelAI ìµœì‹  ëª¨ë¸
    TRANSLATE_KO: 'gemini-2.5-pro'     // ë²ˆì—­ (ì¼â†’í•œ) - Gemini 2.5 Pro
  };

  function buildPrompt(stage, userText){
    switch(stage){
      case 'SKETCH':
        // ìŠ¤ì¼€ì¹˜: ê°ˆë“±â†’ì „í™˜â†’í›„í­í’ 3ë‹¨ êµ¬ì¡° ê°œìš” ìƒì„±
        return `ë„ˆëŠ” ì›¹ì†Œì„¤ ê¸°íš ë³´ì¡°ì•¼. ì•„ë˜ ìš”êµ¬ì‚¬í•­ì„ ê°ˆë“±â†’ì „í™˜â†’í›„í­í’ 3ë‹¨ êµ¬ì¡°ë¡œ ì •ë¦¬í•´ì¤˜.
ê° ë‹¨ê³„ë³„ë¡œ 5-8ë¬¸ì¥ì”© ì‘ì„±í•˜ê³ , ë‹¤ìŒ í•­ëª©ì„ í¬í•¨í•´:
- ê°œìš” (ì¥ë©´ íë¦„)
- í•µì‹¬ ë„êµ¬/ì†Œí’ˆ
- ê°ì • ë³€í™”
- ë‹¤ìŒ ì¥ë©´ í›…

ìš”êµ¬ì‚¬í•­:
${userText}`;
      case 'J_DRAFT':
        // ë³¸ë¬¸ ì´ˆì•ˆ: ì¼ë³¸ì–´ë¡œ 3000-4000ì ì›¹ì†Œì„¤ ìƒì„±
        return `ä»¥ä¸‹ã®è¦ä»¶ã«å¾“ã£ã¦ã€æ—¥æœ¬èªã§ã‚¦ã‚§ãƒ–å°èª¬ã®æœ¬æ–‡ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚

ã€å¿…é ˆè¦ä»¶ã€‘
- æ–‡å­—æ•°: 3,000ï½4,000å­—ã‚’ç›®æ¨™ã¨ã™ã‚‹
- æ”¹è¡Œ: å¿…ãš \\n ã‚’ä½¿ç”¨ (ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ äº’æ›æ€§)
- æ–‡ä½“: ã‚¦ã‚§ãƒ–å°èª¬ã‚‰ã—ãä¼šè©±ã‚’ä¸­å¿ƒã«ã€æ–‡ã”ã¨ã®æ”¹è¡Œã‚’ç©æ¥µçš„ã«æ´»ç”¨
- åŠ¹æœéŸ³(SFX): ã‚»ãƒªãƒ•ã®å¤–ã®åœ°ã®æ–‡ã§è¡¨è¨˜ (ä¾‹: ã€SFXã€‘ï½ï½)
- å›ºæœ‰åè©ãƒ»å£èª¿: ä¸€è²«æ€§ã‚’ä¿ã¤
- ãƒˆãƒ¼ãƒ³/æ¼”å‡º: å ´é¢ã®ç›®çš„ã‚’æ˜ç¢ºã«ã€æ„Ÿæƒ…ç·š/è‘›è—¤-è»¢æ›-ä½™éŸ»ã®æµã‚Œã‚’ç¶­æŒ

ã€è¦ä»¶ã€‘
${userText}

ã€ç¦æ­¢äº‹é …ã€‘
- ä¸å¿…è¦ãªè‹±èªã®æ··åœ¨
- éåº¦ãªãƒ«ãƒ“ã®ä½¿ç”¨
- ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒªã‚·ãƒ¼é•å (æš´åŠ›è¡¨ç¾ãƒ»å€‹äººæƒ…å ±ãƒ»å·®åˆ¥è¡¨ç¾ã®ç¦æ­¢)`;
      case 'J_POLISH':
        // ì¼ë³¸ì–´ ë‹¤ë“¬ê¸°: ì˜ë¯¸ ìœ ì§€í•˜ë©° ë¬¸ì¥ ê°œì„ 
        return `æ¬¡ã®æ—¥æœ¬èªã®ã‚¦ã‚§ãƒ–å°èª¬æœ¬æ–‡ã‚’æ¨æ•²ã—ã¦ãã ã•ã„ã€‚

ã€æ¨æ•²ã®æ–¹é‡ã€‘
- æ„å‘³ã¯å¤‰ãˆãªã„
- å†—é•·ãªè¡¨ç¾ã‚’å‰Šé™¤
- æ–‡ã®ãƒªã‚ºãƒ ã¨å‘¼å¸æ„Ÿã‚’æ”¹å–„
- å£èª¿ã®ä¸€è²«æ€§ã‚’ä¿ã¤
- é•·ã•ã¯ Â±10% ä»¥å†…ã§è‡ªç„¶ã«èª¿æ•´

ã€æœ¬æ–‡ã€‘
${userText}`;
      case 'TRANSLATE_KO':
        // ë²ˆì—­: ì¼ë³¸ì–´â†’í•œêµ­ì–´ ìì—°ìŠ¤ëŸ½ê²Œ
        return `ë‹¤ìŒ ì¼ë³¸ì–´ ì›¹ì†Œì„¤ ë³¸ë¬¸ì„ ìì—°ìŠ¤ëŸ½ê³  ë¬¸í•™ì ì¸ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜.

ã€ë²ˆì—­ ì›ì¹™ã€‘
- ë§ë§›/í†¤ ìœ ì§€, ê³¼í•œ ì˜ì—­ ê¸ˆì§€
- ì¼ë³¸ì–´ ê³ ìœ ëª…ì‚¬ëŠ” ì²« ë“±ì¥ ì‹œì—ë§Œ (ì›ë¬¸) ë³‘ê¸°
- ì›¹ì†Œì„¤ë‹µê²Œ ëŒ€í™”ì™€ ì¤„ë°”ê¿ˆ ì‚´ë¦¬ê¸°
- íš¨ê³¼ìŒ(SFX) í‘œê¸° ìœ ì§€

ã€ì¼ë³¸ì–´ ë³¸ë¬¸ã€‘
${userText}`;
      default:
        return userText;
    }
  }

  async function callProxy(model, prompt, secretKey){
    const res = await fetch('/api/generate', {
      method:'POST',
      headers:{'Content-Type':'application/json', 'x-my-secret-key': secretKey},
      body: JSON.stringify({ model, prompt })
    });
    if(!res.ok){ const t=await res.text(); throw new Error(t||'ìš”ì²­ ì‹¤íŒ¨'); }
    return res.json();
  }

  // ì‹¤í–‰ ë²„íŠ¼
  const generateBtn=$('generateSceneButton');
  const sceneResultEl=$('sceneResult');

  generateBtn.addEventListener('click', async ()=>{
    const userText=$('sceneRequest').value;
    if(!secretKey || !userText) return showToast('í‚¤ ë˜ëŠ” ì…ë ¥ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.', 'warning');

    const stage=($('pipelineStage')||{value:'SKETCH'}).value;
    const model=MODEL_FOR[stage];
    const prompt=buildPrompt(stage, userText);

    const old=generateBtn.textContent; generateBtn.textContent='ìƒì„± ì¤‘...'; generateBtn.disabled=true;
    try{
      const data=await callProxy(model, prompt, secretKey);
      const text=data.text||'';

      // ë³¸ë¬¸ í™”ë©´ì— ì¶”ê°€
      const p=document.createElement('p'); p.textContent=text||' ';
      $('novel-blocks').appendChild(p);

      // ì¼ë³¸ì–´ ë‹¨ê³„ ìºì‹±
      if(stage==='J_DRAFT' || stage==='J_POLISH'){ lastJapaneseDraft=text; }

      sceneResultEl.textContent=`[${data.model}] ì™„ë£Œ`;
      showToast(`${stage} ë‹¨ê³„ ìƒì„± ì™„ë£Œ!`, 'success');
    }catch(e){
      sceneResultEl.textContent=`ì˜¤ë¥˜: ${e.message}`;
      showToast('ì˜¤ë¥˜: ' + e.message, 'error');
    }finally{
      generateBtn.disabled=false; generateBtn.textContent=old;
    }
  });

  // ì›ë¬¸ ë³µì‚¬
  $('copyJapaneseButton').addEventListener('click', async ()=>{
    if(!lastJapaneseDraft) return showToast('ì•„ì§ ì¼ë³¸ì–´ ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
    await navigator.clipboard.writeText(lastJapaneseDraft);
    showToast('ì¼ë³¸ì–´ ì›ë¬¸ ë³µì‚¬ ì™„ë£Œ!', 'success');
  });

  // ë³¸ë¬¸ ì €ì¥(ë¡œì»¬)
  $('saveContentButton').addEventListener('click', ()=>{
    const arr=load(); const n=arr.find(x=>x.id===novelId); if(!n) return showToast('ì†Œì„¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    const ep=getEpisode(n); if(!ep) return showToast('íšŒì°¨ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    const blocks=[...document.querySelectorAll('#novel-blocks p')].map(p=>p.textContent);
    ep.content = blocks.join('\n\n');
    ep.updatedAt=Date.now(); n.updatedAt=Date.now(); save(arr);
    showToast('ë³¸ë¬¸ ì €ì¥ ì™„ë£Œ!', 'success');
  });

  // íšŒì°¨ DB ì €ì¥(ë¡œì»¬)
  $('saveEpisodeDbButton').addEventListener('click', ()=>{
    const arr=load(); const n=arr.find(x=>x.id===novelId); if(!n) return showToast('ì†Œì„¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    const ep=getEpisode(n); if(!ep) return showToast('íšŒì°¨ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    ep.episodeDB = $('dbAfter').value;
    ep.updatedAt=Date.now(); n.updatedAt=Date.now(); save(arr);
    showToast('íšŒì°¨ DB ì €ì¥ ì™„ë£Œ!', 'success');
  });

  // í¸ì˜ í”„ë¡¬í”„íŠ¸(Flash-lite)
  const proxyBtn=document.getElementById('proxyButton');
  const proxyResultEl=document.getElementById('proxyResult');
  proxyBtn.addEventListener('click', async ()=>{
    const prompt=document.getElementById('proxyPrompt').value;
    if(!secretKey || !prompt) return showToast('í‚¤ ë˜ëŠ” í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
    proxyBtn.disabled=true;
    const oldText = proxyBtn.textContent;
    proxyBtn.textContent = 'ì „ì†¡ ì¤‘...';
    try{
      const data=await callProxy('gemini-2.5-flash-lite', prompt, secretKey);
      proxyResultEl.textContent=data.text||'';
      showToast('ì‘ë‹µ ì™„ë£Œ', 'success');
    }catch(e){
      proxyResultEl.textContent=`ì˜¤ë¥˜: ${e.message}`;
      showToast('ì˜¤ë¥˜ ë°œìƒ: ' + e.message, 'error');
    }finally{
      proxyBtn.disabled=false;
      proxyBtn.textContent = oldText;
    }
  });

  // ê¸°ì¡´ íšŒì°¨ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸°(ìˆìœ¼ë©´)
  (function loadEpisodeContent(){
    const n=getNovel(); if(!n) return;
    const ep=getEpisode(n); if(!ep) return;
    if(ep.content){
      ep.content.split(/\n\s*\n/).forEach(chunk=>{
        const p=document.createElement('p'); p.textContent=chunk; $('novel-blocks').appendChild(p);
      });
    }
    if(ep.episodeDB){ $('dbAfter').value=ep.episodeDB; }
    $('dbBefore').value='(ì°¸ê³ ) ì—¬ê¸°ì— ë§ˆìŠ¤í„°/ì´ì „ íšŒì°¨ì˜ ìºë¦­í„° ìƒíƒœë¥¼ ë„£ì–´ë„ ì¢‹ì•„.';
  })();
</script>
</body>
</html>
