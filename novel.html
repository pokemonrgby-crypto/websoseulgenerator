<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ì§‘í•„ì‹¤ (V6.2)</title>
  <style>
    body { font-family:-apple-system,sans-serif; background:#f0f2f5; }
    .editor-layout{ display:grid; grid-template-columns: 1fr 360px; gap:20px; padding:20px; max-width:1600px; margin:0 auto; height:calc(100vh - 40px); }
    .main-content{ background:#fff; border-radius:12px; padding:20px; display:flex; flex-direction:column; gap:12px; }
    .side{ background:#fff; border-radius:12px; padding:20px; display:flex; flex-direction:column; gap:16px; }
    h2 { margin:0 0 4px 0; }
    textarea, input { width:100%; border:1px solid #ddd; border-radius:8px; padding:10px; font-family:inherit; }
    button { background:#007aff; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button.sub-ai { background:#6c757d; }
    pre { white-space:pre-wrap; word-break:break-word; }
    .blocks p { margin:8px 0; line-height:1.6; }
  </style>
</head>
<body>

<!-- [KEYBAR START] -->
<div id="keybar" style="position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #eee;padding:10px 12px;margin:-20px -20px 10px -20px;display:flex;gap:8px;align-items:center;">
  <strong>ğŸ”‘ ê²½ë¹„ì‹¤ í‚¤</strong>
  <input id="secretKeyInput" placeholder="MY_SECRET_KEY" style="flex:1;max-width:360px;padding:8px;border:1px solid #ddd;border-radius:8px;">
  <button id="saveSecretKeyButton" style="padding:8px 12px;border:0;border-radius:8px;background:#007aff;color:#fff;">ì €ì¥</button>
  <button id="deleteSecretKeyButton" style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#fff;">ì‚­ì œ</button>
  <span id="keyStatus" style="margin-left:8px;color:#666;font-size:12px;"></span>
</div>
<script>
(function(){
  const $=id=>document.getElementById(id);
  const input=$('secretKeyInput'), status=$('keyStatus');
  const v=localStorage.getItem('MY_SECRET_KEY')||'';
  input.value=v; status.textContent=v?'ì €ì¥ë¨':'ë¯¸ì €ì¥';
  $('saveSecretKeyButton').onclick=()=>{ const t=input.value.trim(); if(!t) return alert('ê°’ì´ ë¹„ì–´ìˆì–´.'); localStorage.setItem('MY_SECRET_KEY',t); status.textContent='ì €ì¥ë¨'; alert('í‚¤ ì €ì¥ ì™„ë£Œ!'); };
  $('deleteSecretKeyButton').onclick=()=>{ localStorage.removeItem('MY_SECRET_KEY'); input.value=''; status.textContent='ë¯¸ì €ì¥'; alert('í‚¤ ì‚­ì œ ì™„ë£Œ!'); };
})();
</script>
<!-- [KEYBAR END] -->

<div class="editor-layout">
  <div class="main-content">
    <h2 id="episodeTitle">ì§‘í•„</h2>
    <label>í•µì‹¬ í”„ë¡¬í”„íŠ¸(ê¸°íš/ë³¸ì‘ì„±/ë‹¤ë“¬ê¸°/ë²ˆì—­ì— ê³µí†µìœ¼ë¡œ ì‚¬ìš©ë  ì…ë ¥)</label>
    <textarea id="sceneRequest" rows="8" placeholder="ì—¬ê¸°ì— ìš”êµ¬ì‚¬í•­/ì´ì–´ì“°ê¸° ë‚´ìš© ë“±ì„ ì ì–´ì¤˜. (ë³¸ì‘ì„±ì€ ì¼ë³¸ì–´ë¡œ ê²°ê³¼ê°€ ë‚˜ì™€)"></textarea>

    <div>
      <select id="pipelineStage" style="margin-right:8px;">
        <option value="SKETCH">ê¸°íš(Flash)</option>
        <option value="J_DRAFT">ë³¸ì‘ì„±(NAI/ì¼ë³¸ì–´)</option>
        <option value="J_POLISH">ë‹¤ë“¬ê¸°(NAI/ì¼ë³¸ì–´)</option>
        <option value="TRANSLATE_KO">ë²ˆì—­(G2.5 Pro)</option>
      </select>
      <button id="generateSceneButton">âœ¨ ì‹¤í–‰</button>
      <button id="copyJapaneseButton" class="sub-ai" style="margin-left:8px;">ğŸ§· ì›ë¬¸(ì¼ë³¸ì–´) ë³µì‚¬</button>
    </div>

    <div class="blocks" id="novel-blocks"></div>
    <pre id="sceneResult" style="background:#f6f6f6;padding:8px;border-radius:8px;"></pre>
  </div>

  <div class="side">
    <fieldset style="border:1px solid #ddd;border-radius:12px;padding:12px;">
      <legend>íšŒì°¨ ë°ì´í„°(ì°¸ê³ /ìˆ˜ì •)</legend>
      <label>ë³€ê²½ ì „(ì°¸ê³ )</label>
      <textarea id="dbBefore" rows="4" readonly>{"name":"A","status":"íŒ” ìˆìŒ"}</textarea>
      <label>ë³€ê²½ í›„(ì €ì¥ ëŒ€ìƒ)</label>
      <textarea id="dbAfter" rows="4">{"name":"A","status":"íŒ” ì—†ìŒ"}</textarea>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button id="saveEpisodeDbButton" class="sub-ai">íšŒì°¨ DB ì €ì¥</button>
        <button id="saveContentButton" class="sub-ai">ë³¸ë¬¸ ì €ì¥</button>
      </div>
    </fieldset>

    <fieldset style="border:1px solid #ddd;border-radius:12px;padding:12px;">
      <legend>í¸ì˜ í”„ë¡¬í”„íŠ¸(Flash)</legend>
      <textarea id="proxyPrompt" rows="4" placeholder="ë¹ ë¥¸ ì§ˆë¬¸/ìš”ì•½ ë“±"></textarea>
      <button id="proxyButton" class="sub-ai">ë³´ë‚´ê¸°</button>
      <pre id="proxyResult" style="background:#f6f6f6;padding:8px;border-radius:8px;"></pre>
    </fieldset>
  </div>
</div>

<script>
  const params=new URLSearchParams(location.search);
  const novelId=params.get('id'); const episodeNum=Number(params.get('ep')||1);
  const secretKey=localStorage.getItem('MY_SECRET_KEY');

  const LS_KEY='novels';
  const $=id=>document.getElementById(id);

  function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
  function save(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
  function getNovel(){ return load().find(n=>n.id===novelId); }
  function getEpisode(n){ return (n.episodes||[]).find(e=>e.no===episodeNum); }

  // ì œëª© ì„¸íŒ…
  (function initTitle(){
    $('episodeTitle').textContent=`${novelId} - ${episodeNum}í™” ì§‘í•„ ì¤‘`;
  })();

  // íŒŒì´í”„ë¼ì¸ & ëª¨ë¸ ë§¤í•‘
  let lastJapaneseDraft = "";
  const MODEL_FOR = {
    SKETCH: 'gemini-2.5-flash',
    J_DRAFT: 'novelai',
    J_POLISH: 'novelai',
    TRANSLATE_KO: 'gemini-2.5-pro'
  };

  function buildPrompt(stage, userText){
    switch(stage){
      case 'SKETCH':
        return `ë„ˆëŠ” ì›¹ì†Œì„¤ ê¸°íš ë³´ì¡°ì•¼. ì•„ë˜ ìš”êµ¬ë¥¼ ê°„ê²°í•œ ì¥ë©´ ê°œìš”(ê°ˆë“±/ì „í™˜/í›„í­í’)ë¡œ ì •ë¦¬í•´ì¤˜.\nìš”êµ¬:\n${userText}`;
      case 'J_DRAFT':
        return `ä»¥ä¸‹ã®è¦ä»¶ã«å¾“ã£ã¦ã€æ—¥æœ¬èªã§å°èª¬ã®æœ¬æ–‡ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚\n- æ–‡ä½“: èª­ã¿ã‚„ã™ãã€è‡¨å ´æ„Ÿã‚’é‡è¦–\n- ç¦æ­¢: ä¸è¦ãªè‹±èªæ··åœ¨ã€éåº¦ãªãƒ«ãƒ“\n- é•·ã•: ${Math.min(900, Math.max(400, userText.length))}ï½1200å­—ç¨‹åº¦\nè¦ä»¶:\n${userText}`;
      case 'J_POLISH':
        return `æ¬¡ã®æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã‚’ã€æ–‡ä½“ã¨ãƒªã‚ºãƒ ã‚’æ•´ãˆã¦æ¨æ•²ã—ã¦ãã ã•ã„ã€‚æ„å‘³ã¯å¤‰ãˆãšã€å†—é•·ã•ã‚’æ¸›ã‚‰ã—ã¦è‡ªç„¶ãªåœ°ã®æ–‡ã«ã—ã¦ãã ã•ã„ã€‚\n---\n${userText}`;
      case 'TRANSLATE_KO':
        return `ë‹¤ìŒ ì¼ë³¸ì–´ ì†Œì„¤ ë³¸ë¬¸ì„ ìì—°ìŠ¤ëŸ½ê³  ë¬¸í•™ì ì¸ í•œêµ­ì–´ë¡œ ë²ˆì—­í•´ì¤˜.\n- ë§ë§›/í†¤ ìœ ì§€, ê³¼í•œ ì˜ì—­ ê¸ˆì§€\n- ì¼ë³¸ì–´ ê³ ìœ ëª…ì‚¬ëŠ” í•„ìš”ì‹œ ()ë¡œ í•œ ë²ˆ ë³‘ê¸°\n---\n${userText}`;
      default:
        return userText;
    }
  }

  async function callProxy(model, prompt, secretKey){
    const res = await fetch('/api/generate', {
      method:'POST',
      headers:{'Content-Type':'application/json', 'x-my-secret-key': secretKey},
      body: JSON.stringify({ model, prompt })
    });
    if(!res.ok){ const t=await res.text(); throw new Error(t||'ìš”ì²­ ì‹¤íŒ¨'); }
    return res.json();
  }

  // ì‹¤í–‰ ë²„íŠ¼
  const generateBtn=$('generateSceneButton');
  const sceneResultEl=$('sceneResult');

  generateBtn.addEventListener('click', async ()=>{
    const userText=$('sceneRequest').value;
    if(!secretKey || !userText) return alert('í‚¤ ë˜ëŠ” ì…ë ¥ì´ ë¹„ì–´ ìˆì–´.');

    const stage=($('pipelineStage')||{value:'SKETCH'}).value;
    const model=MODEL_FOR[stage];
    const prompt=buildPrompt(stage, userText);

    const old=generateBtn.textContent; generateBtn.textContent='ìƒì„± ì¤‘...'; generateBtn.disabled=true;
    try{
      const data=await callProxy(model, prompt, secretKey);
      const text=data.text||'';

      // ë³¸ë¬¸ í™”ë©´ì— ì¶”ê°€
      const p=document.createElement('p'); p.textContent=text||' ';
      $('novel-blocks').appendChild(p);

      // ì¼ë³¸ì–´ ë‹¨ê³„ ìºì‹±
      if(stage==='J_DRAFT' || stage==='J_POLISH'){ lastJapaneseDraft=text; }

      sceneResultEl.textContent=`[${data.model}] ì™„ë£Œ`;
    }catch(e){
      sceneResultEl.textContent=`ì˜¤ë¥˜: ${e.message}`;
    }finally{
      generateBtn.disabled=false; generateBtn.textContent=old;
    }
  });

  // ì›ë¬¸ ë³µì‚¬
  $('copyJapaneseButton').addEventListener('click', async ()=>{
    if(!lastJapaneseDraft) return alert('ì•„ì§ ì¼ë³¸ì–´ ë³¸ë¬¸ì´ ì—†ì–´.');
    await navigator.clipboard.writeText(lastJapaneseDraft);
    alert('ì¼ë³¸ì–´ ì›ë¬¸ ë³µì‚¬ ì™„ë£Œ!');
  });

  // ë³¸ë¬¸ ì €ì¥(ë¡œì»¬)
  $('saveContentButton').addEventListener('click', ()=>{
    const arr=load(); const n=arr.find(x=>x.id===novelId); if(!n) return;
    const ep=getEpisode(n); if(!ep) return;
    const blocks=[...document.querySelectorAll('#novel-blocks p')].map(p=>p.textContent);
    ep.content = blocks.join('\n\n');
    ep.updatedAt=Date.now(); n.updatedAt=Date.now(); save(arr);
    alert('ë³¸ë¬¸ ì €ì¥ ì™„ë£Œ!');
  });

  // íšŒì°¨ DB ì €ì¥(ë¡œì»¬)
  $('saveEpisodeDbButton').addEventListener('click', ()=>{
    const arr=load(); const n=arr.find(x=>x.id===novelId); if(!n) return;
    const ep=getEpisode(n); if(!ep) return;
    ep.episodeDB = $('dbAfter').value;
    ep.updatedAt=Date.now(); n.updatedAt=Date.now(); save(arr);
    alert('íšŒì°¨ DB ì €ì¥ ì™„ë£Œ!');
  });

  // í¸ì˜ í”„ë¡¬í”„íŠ¸(Flash)
  const proxyBtn=document.getElementById('proxyButton');
  const proxyResultEl=document.getElementById('proxyResult');
  proxyBtn.addEventListener('click', async ()=>{
    const prompt=document.getElementById('proxyPrompt').value;
    if(!secretKey || !prompt) return alert('í‚¤ ë˜ëŠ” í”„ë¡¬í”„íŠ¸ê°€ ì—†ì–´.');
    proxyBtn.disabled=true;
    try{
      const data=await callProxy('gemini-2.5-flash', prompt, secretKey);
      proxyResultEl.textContent=data.text||'';
    }catch(e){
      proxyResultEl.textContent=`ì˜¤ë¥˜: ${e.message}`;
    }finally{
      proxyBtn.disabled=false;
    }
  });

  // ê¸°ì¡´ íšŒì°¨ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸°(ìˆìœ¼ë©´)
  (function loadEpisodeContent(){
    const n=getNovel(); if(!n) return;
    const ep=getEpisode(n); if(!ep) return;
    if(ep.content){
      ep.content.split(/\n\s*\n/).forEach(chunk=>{
        const p=document.createElement('p'); p.textContent=chunk; $('novel-blocks').appendChild(p);
      });
    }
    if(ep.episodeDB){ $('dbAfter').value=ep.episodeDB; }
    $('dbBefore').value='(ì°¸ê³ ) ì—¬ê¸°ì— ë§ˆìŠ¤í„°/ì´ì „ íšŒì°¨ì˜ ìºë¦­í„° ìƒíƒœë¥¼ ë„£ì–´ë„ ì¢‹ì•„.';
  })();
</script>
</body>
</html>
