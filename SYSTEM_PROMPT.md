// /SYSTEM_PROMPT.md
# 시스템 프롬프트 (프로젝트 전용 · 개발 규칙 · 보강판)

이 프롬프트는 본 프로젝트(웹소설 집필 도구: Vercel 프록시 + HTML 프론트)에 공통 적용된다. 코드·문서 충돌 시 **코드 우선**이며, 모든 주석/출력은 한국어로 한다.

## 0) 모델 정책(최우선 원칙)

* **NovelAI는 항상 최신/최상 모델**을 사용한다. 기본값은 환경변수/설정으로 관리하며, **주기적으로 최신 모델명을 확인**해 갱신한다.
* 합법·약관 준수 범위에서, 가능하면 **Gemini 대신 NovelAI 최신 모델**로 대체한다(단, 번역은 Gemini 2.5 Pro 유지).
* 개인 사용 기준이며, 계정 공유·우회·과부하는 금지. 호출은 직렬(동시에 1개)로 처리하고, 오류 시 지수 백오프로 감속한다.

## 1) 파일 구조·분할

* 코드는 유지보수를 위해 **최대한 분리**한다. 한 파일은 1,000줄 이하(권장 500줄 이하).
* 반복 로직은 공용 모듈로 이동. **파일 첫 줄에 경로 주석**을 넣는다(예: `// /api/generate.js`, `// /public/editor.html`).

## 2) TODO 주석

* "구현 예정"만 적지 말고, **자연어로 대략적인 구현 로직**을 함께 남긴다.
* 구현 미완·모순·애매한 부분은 해당 코드 구간에 **TODO**로 표시한다.

## 3) 프론트엔드 구현·디자인 지침

* **로직은 실제 구현**, 디자인은 기초만. 세부 디자인은 주석으로 **작동 방식(호출 함수·비활성 조건·모바일 대응)**을 상세히 기록한다.
* 모든 **실행 버튼은 처리 완료까지 비활성화**. 결과·오류는 **최상단 토스트**로 안내, 확인성 액션은 **모달** 사용.
* 모달 중첩 시 **최근 모달이 최상위(z-order)** 가 되도록 한다.
* 글자/배경 **대비 확보**, **이모지 대신 아이콘** 세트 사용(향후 디자인 시스템으로 교체 가능).
* 각 화면은 **그 장면에 필요한 데이터만** 서버/스토리지에서 로드하도록 **명확·효율** 설계.

## 4) 인증·접근

* 최종판은 **Google 로그인 후** 사용. 개발 중에는 **경비실 헤더(MY_SECRET_KEY)** 로 접근 허용(프론트 키 바에서 저장).
* Firebase Auth 전환 시 **로그인 없이는 에디터 진입 불가**.

## 5) 백엔드·리전·배포

* 현재 호스팅/프록시는 **Vercel Serverless** 기준으로 진행.
* 향후 Firebase Functions는 **v2 + asia-northeast3**로 통일한다.
* **createdAt/updatedAt 등 시간 필드**는 **타임스탬프(ms)** 로 통일.
* 배포는 **GitHub Actions**로 자동화.

## 6) AI 모델 사용 원칙(이 프로젝트 전용)

* **스케치/보조(간단 질의)**: `gemini-2.5-flash-lite` (필요 시 NAI-brief 대체 가능).
* **본문 초안/다듬기**: **NovelAI(최신/최상 모델)** — **결과는 반드시 일본어**.
* **번역(일본어→한국어)**: `gemini-2.5-pro`.
* Gemini 호출은 **안전 필터** 적용, 토큰은 **여유 있게**.
* **고정 필드(id, createdAt/updatedAt, 사용자 id 등)** 는 **서버/클라이언트 로직에서 채운다**(AI에 생성 요구 금지).

## 7) 데이터·트랜잭션

* 현재는 로컬 저장소 기반. Firestore 도입 시 **"모든 read 후 write"** 규칙을 반드시 지킨다.
* 자동 저장/스냅샷 구현 시 버전 최대 n개 보관.

## 8) 언어·문서화

* 모든 주석/UI 문자열/로그는 **한국어**. 파일 첫 줄에 **파일 경로/이름 주석**을 넣는다.
* README 규칙을 적극 참고하되, **코드와 문서 충돌 시 코드 우선**. 모든 응답/출력은 한국어.

## 9) 파이프라인·플래그

* 단계: **SKETCH → J_DRAFT → J_POLISH → TRANSLATE_KO**.
* 모델은 **플래그로 결정**(예: `SKETCH: flash-lite`, `J_DRAFT/J_POLISH: nai_latest`, `TRANSLATE_KO: gem_pro`).
* 지시 프롬프트는 기본 **로컬 템플릿(0원)** → 필요 시 **NAI-brief(저토큰) 보강**. 캐시 재사용.

## 10) "소설 생성" 플로우(모달 기반)

1. **소설 생성** 버튼 클릭 시 **모달**이 뜬다(새 창/팝업 금지).
2. 모달에서 **제목** 입력 및 **리소스 생성** 가능.
3. **리소스 카드(체크박스)** UI로 "이번 회차 프롬프트에 포함할 리소스"를 선택/해제 가능.
4. **확정** 시: 소설 문서/회차 1화/리소스 뼈대를 저장하고 에디터로 진입.

## 11) 리소스 정의·저장 규칙

* **리소스** = 등장인물, 배경, 장소, **고유 용어**, 관계도(선택/후생성), (옵션) 아이템·스킬 등.
* 속성은 **해당 리소스 문서의 하위 필드**로 구조화(예: 캐릭터 나이/성격/말투, 상태창/스탯은 `maps/arrays`).
* 저장 범위:

  * **소설 레벨 리소스**: `novels/{novelId}/resources/*` (마스터/기본)
  * **회차 레벨 리소스**: `novels/{novelId}/episodes/{ep}/resources/*` (회차 스냅샷)
* **참조 규칙**: 회차 프롬프트는 **회차 리소스**를 우선, 없으면 **소설 리소스 최신본**을 사용한다.
* 리소스 CRUD는 **직접 입력**과 **AI 보조 입력**을 모두 지원한다. 코딩을 몰라도 필드/문서를 추가할 수 있어야 한다.

## 12) 회차 생성 규격(중요)

* **모델**: **NovelAI 최신/최상 모델**로 생성한다.
* **언어**: **일본어**.
* **길이**: **3,000~4,000자** 목표(필요 시 ±10% 범위 허용).
* **포맷**:

  * 줄바꿈은 반드시 **`\n`** 사용(플랫폼 호환성).
  * **웹소설답게 대화 위주**, **문장마다 줄바꿈**을 적극 활용.
  * **효과음(SFX)은 대사 밖 서술**에 표기(예: `【SFX】～～`).
  * 필요 시 **이전 화 일본어 원문** 일부를 요약/참조해 **연속성**을 유지한다.
* **톤/연출**: 장면 목적 명확, 감정선/갈등-전환-여운 흐름 유지, 고유명사·말투 일관.
* **안전**: 서비스 정책을 준수한다(수위·개인정보·차별 표현 금지 등).

## 13) 회차/리소스 동기화

* 회차 저장 시 **변화가 발생한 리소스만** 회차 리소스로 스냅샷한다.
* **소설 리소스 최신본**은 마지막 회차 저장 시 **반영**해 일관성을 유지한다.

## 14) 에디터/관리 화면

* 소설 카드를 클릭하면 **회차 목록 + 회차 관리(상세 탭)**, **리소스 관리**를 제공한다.
* **리소스 관리는 최신 회차 기준**으로 보여주며, 카드/표 혼합 UI로 **게임 UI처럼 빠른 열람/검색/필드 편집**이 가능해야 한다(세부 디자인은 주석으로 설명).

## 15) 호출·비용 최적화(개인 사용 가정)

* **직렬 처리(동시 1개)** + 버튼 비활성화로 **중복 호출 방지**.
* 지시 프롬프트는 **로컬 생성 → 필요 시 NAI-brief**(짧은 토큰) 1회 보강.
* 같은 회차에서는 **지시문/요약 캐시 재사용**.
* 에러 429/5xx 시 **지수 백오프(1→2→4초, 최대 3회)**.

---

## [AI 입력·출력 스펙(요약용 템플릿)]

### A) SKETCH (스케치 개요 · 기본 Flash-lite)

* 목적: 선택한 리소스 + 사용자 메모로 **갈등→전환→후폭풍** 3단 구조 개요 생성.
* 출력: 개요, 핵심 도구/소품, 감정 변화, 다음 장면 훅(항목별 5~8문장).
* 필요 시 NovelAI-brief로 **일본어 지시문(10~14행)** 보강 생성.

### B) J_DRAFT (본문 초안 · **NAI 최신/최상**, 일본어)

* 조건: **3,000~4,000자**, **`\n` 줄바꿈**, **대화 위주**, **SFX는 대사 밖 서술**.
* 리소스 충돌 금지(말투/관계/고유명사 일관).
* 이전 화가 있으면 **일본어 원문** 일부 참조/요약 반영 가능.

### C) J_POLISH (일본어 다듬기 · NAI 최신/최상)

* 의미 유지, 군더더기 제거, 문장 리듬/호흡 개선, 말투 일관.
* 길이 ±10% 내에서 자연스럽게.

### D) TRANSLATE_KO (번역 · Gemini 2.5 Pro)

* 일본어 본문을 자연스러운 한국어로 번역.
* 말맛·톤 유지, 과한 의역 금지, 고유명사는 첫 등장에만 (원문) 병기.

---

## 환경변수 설정

Vercel 대시보드 또는 `.env` 파일에 다음 변수를 설정하세요:

```bash
# 인증
MY_SECRET_KEY=your_secret_key_here

# AI API 키
GEMINI_API_KEY=your_gemini_api_key_here
NOVELAI_API_KEY=your_novelai_api_key_here

# NovelAI 모델 설정
NOVELAI_MODEL=kayra-v1  # 최신 모델로 주기적 업데이트
NOVELAI_MAX_LENGTH=4000  # 3000-4000자 목표
```

## 참고 문서

- README.md: 프로젝트 가이드라인
- DEPLOYMENT.md: 배포 가이드
- VERIFICATION.md: 요구사항 검증 체크리스트
