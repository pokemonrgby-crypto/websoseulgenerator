// /SYSTEM_PROMPT.md
# 시스템 프롬프트 (프로젝트 전용 · 개발 규칙)

이 문서는 웹소설 집필 도구 프로젝트의 공통 개발 원칙을 정의합니다.
코드와 문서가 충돌할 경우 **코드를 우선**합니다.

## 0) 모델 정책 (최우선 원칙)

### NovelAI 최신/최상 모델 사용
- **NovelAI는 항상 최신/최상 모델**을 사용합니다
- 환경변수 `NOVELAI_MODEL`로 관리 (기본값: `kayra-v1`)
- 주기적으로 최신 모델명을 확인하여 갱신합니다
- `NOVELAI_MAX_LENGTH`: 3000-4000자 목표 (환경변수, 기본값: 4000)

### 모델 우선순위
- **Gemini 대신 NovelAI 최신 모델** 사용 (단, 번역은 Gemini 2.5 Pro 유지)
- 합법·약관 준수 범위 내에서만 사용
- 개인 사용 기준, 계정 공유·우회·과부하 금지

### 호출 관리
- **직렬 처리** (동시에 1개만)
- 오류 시 **지수 백오프** (1s → 2s → 4s, 최대 3회)
- 429/5xx 에러 시 자동 재시도

## 1) 파일 구조·분할

- 코드는 유지보수를 위해 **최대한 분리**
- 한 파일은 1,000줄 이하 (권장 500줄 이하)
- 반복 로직은 공용 모듈로 이동
- **파일 첫 줄에 경로 주석** 필수 (예: `// /api/generate.js`, `<!-- /index.html -->`)

## 2) TODO 주석

- "구현 예정"만 적지 말고, **자연어로 대략적인 구현 로직** 함께 기록
- 구현 미완·모순·애매한 부분은 **TODO**로 표시

## 3) 프론트엔드 구현·디자인 지침

### 로직과 디자인
- **로직은 실제 구현**, 디자인은 기초만
- 세부 디자인은 주석으로 **작동 방식** 상세 기록
  - 호출 함수
  - 비활성화 조건
  - 모바일 대응 방식

### UI/UX 규칙
- **모든 실행 버튼은 처리 완료까지 비활성화**
- 결과·오류는 **최상단 토스트**로 안내
- 확인성 액션은 **모달** 사용
- 모달 중첩 시 **최근 모달이 최상위 (z-order)**
- 글자/배경 **대비 확보**
- **이모지 대신 아이콘** 세트 사용
- 각 화면은 **필요한 데이터만** 로드 (효율 설계)

## 4) 인증·접근

- 개발 중: **경비실 헤더 (MY_SECRET_KEY)** 로 접근
- 프론트엔드: 키 바에서 저장
- 최종판: **Google 로그인** 후 사용 (Firebase Auth 전환 시)

## 5) 백엔드·리전·배포

### 호스팅
- **Vercel Serverless** 사용
- 리전: **icn1 (서울/인천)** - `vercel.json`에 설정

### 타임스탬프
- `createdAt`, `updatedAt` 등 시간 필드는 **타임스탬프(ms)** 통일

### 배포
- **GitHub Actions** 자동화 (또는 Vercel GitHub 연동)

## 6) AI 모델 사용 원칙

### 파이프라인별 모델

| 단계 | 모델 | 용도 | 비고 |
|------|------|------|------|
| SKETCH | gemini-2.5-flash-lite | 스케치/간단 질의 | 갈등→전환→후폭풍 개요 |
| J_DRAFT | NovelAI (최신) | 본문 초안 | **일본어**, 3000-4000자 |
| J_POLISH | NovelAI (최신) | 다듬기 | **일본어** 개선 |
| TRANSLATE_KO | gemini-2.5-pro | 번역 | 일본어 → 한국어 |

### 공통 규칙
- Gemini 호출 시 **안전 필터** 적용
- 토큰은 **여유 있게** (maxOutputTokens: 8192)
- **고정 필드** (id, createdAt/updatedAt, 사용자 id)는 서버/클라이언트 로직에서 처리
- AI에 생성 요구 금지

## 7) 데이터·트랜잭션

### 현재: 로컬 저장소
- localStorage 기반
- Firestore 도입 시: **"모든 read 후 write"** 규칙 준수

### 자동 저장
- 버전 최대 n개 보관 (스냅샷)

## 8) 언어·문서화

- **모든 주석/UI 문자열/로그는 한국어**
- 파일 첫 줄: **경로/이름 주석**
- README 규칙 참고하되, **코드 우선**

## 9) 파이프라인·플래그

### 단계
1. **SKETCH** → 2. **J_DRAFT** → 3. **J_POLISH** → 4. **TRANSLATE_KO**

### 플래그 기반 모델 결정
```javascript
const MODEL_FOR = {
  SKETCH: 'gemini-2.5-flash-lite',
  J_DRAFT: 'novelai',
  J_POLISH: 'novelai',
  TRANSLATE_KO: 'gemini-2.5-pro'
};
```

### 지시 프롬프트
- 기본: **로컬 템플릿** (0원)
- 필요 시: **NAI-brief** (저토큰) 보강
- 캐시 재사용

## 10) 소설 생성 플로우 (모달 기반)

1. **소설 생성** 버튼 → **모달** 오픈 (새 창/팝업 금지)
2. 모달에서 **제목** 입력 및 **리소스 생성** 가능
3. **리소스 카드 (체크박스)** UI로 선택/해제
4. **확정** 시: 소설 문서/회차 1화/리소스 뼈대 저장 → 에디터 진입

## 11) 리소스 정의·저장 규칙

### 리소스 종류
- 등장인물
- 배경/장소
- **고유 용어**
- 관계도 (선택/후생성)
- (옵션) 아이템, 스킬 등

### 속성 구조화
- 해당 리소스 문서의 **하위 필드**로 저장
- 예: 캐릭터 나이/성격/말투, 상태창/스탯 (`maps/arrays`)

### 저장 범위
- **소설 레벨**: `novels/{novelId}/resources/*` (마스터/기본)
- **회차 레벨**: `novels/{novelId}/episodes/{ep}/resources/*` (회차 스냅샷)

### 참조 규칙
- 회차 프롬프트: **회차 리소스** 우선
- 없으면: **소설 리소스 최신본** 사용

### CRUD
- **직접 입력** + **AI 보조 입력** 모두 지원
- 코딩 없이도 필드/문서 추가 가능해야 함

## 12) 회차 생성 규격 (중요)

### 모델
- **NovelAI 최신/최상 모델**

### 언어
- **일본어**

### 길이
- **3,000~4,000자** 목표
- 필요 시 ±10% 범위 허용

### 포맷
- 줄바꿈: **`\n`** 사용 (플랫폼 호환성)
- **웹소설답게 대화 위주**
- **문장마다 줄바꿈** 적극 활용
- **효과음 (SFX)**: 대사 밖 서술에 표기 (예: `【SFX】～～`)
- 필요 시 **이전 화 일본어 원문** 일부 요약/참조해 **연속성** 유지

### 톤/연출
- 장면 목적 명확
- 감정선/갈등-전환-여운 흐름 유지
- 고유명사·말투 일관

### 안전
- 서비스 정책 준수
- 수위·개인정보·차별 표현 금지

## 13) 회차/리소스 동기화

- 회차 저장 시 **변화가 발생한 리소스만** 회차 리소스로 스냅샷
- **소설 리소스 최신본**은 마지막 회차 저장 시 **반영**

## 14) 에디터/관리 화면

### 기능
- 소설 카드 클릭 → **회차 목록 + 회차 관리 (상세 탭)**
- **리소스 관리** 제공

### 리소스 관리 UI
- **최신 회차 기준**으로 표시
- 카드/표 혼합 UI
- **게임 UI처럼 빠른 열람/검색/필드 편집**
- 세부 디자인은 주석으로 설명

## 15) 호출·비용 최적화

### 개인 사용 가정
- **직렬 처리 (동시 1개)**
- 버튼 비활성화로 **중복 호출 방지**

### 프롬프트 최적화
- 지시 프롬프트: **로컬 생성**
- 필요 시: **NAI-brief** (짧은 토큰) 1회 보강

### 캐싱
- 같은 회차에서 **지시문/요약 캐시 재사용**

### 에러 처리
- 429/5xx 시 **지수 백오프** (1s → 2s → 4s, 최대 3회)

---

## AI 입력·출력 스펙 (템플릿)

### A) SKETCH (스케치 개요)

**목적**: 선택한 리소스 + 사용자 메모 → **갈등→전환→후폭풍** 3단 구조 개요 생성

**출력**:
- 개요 (장면 흐름)
- 핵심 도구/소품
- 감정 변화
- 다음 장면 훅
- 각 항목별 5~8문장

**모델**: gemini-2.5-flash-lite

**보강**: 필요 시 NovelAI-brief로 **일본어 지시문 (10~14행)** 생성

### B) J_DRAFT (본문 초안)

**모델**: NovelAI (최신/최상)

**언어**: **일본어**

**조건**:
- **3,000~4,000자**
- **`\n` 줄바꿈**
- **대화 위주**
- **SFX는 대사 밖 서술**
- 리소스 충돌 금지 (말투/관계/고유명사 일관)
- 이전 화가 있으면 **일본어 원문** 일부 참조/요약 반영 가능

### C) J_POLISH (일본어 다듬기)

**모델**: NovelAI (최신/최상)

**작업**:
- 의미 유지
- 군더더기 제거
- 문장 리듬/호흡 개선
- 말투 일관
- 길이 ±10% 내에서 자연스럽게

### D) TRANSLATE_KO (번역)

**모델**: Gemini 2.5 Pro

**작업**:
- 일본어 본문 → 자연스러운 한국어
- 말맛·톤 유지
- 과한 의역 금지
- 고유명사: 첫 등장에만 (원문) 병기

---

## 환경변수 설정

Vercel 대시보드 또는 `.env` 파일에 다음 변수를 설정하세요:

```bash
# 인증
MY_SECRET_KEY=your_secret_key_here

# AI API 키
GEMINI_API_KEY=your_gemini_api_key_here
NOVELAI_API_KEY=your_novelai_api_key_here

# NovelAI 모델 설정
NOVELAI_MODEL=kayra-v1  # 최신 모델로 주기적 업데이트
NOVELAI_MAX_LENGTH=4000  # 3000-4000자 목표
```

## 참고 문서

- README.md: 프로젝트 가이드라인
- DEPLOYMENT.md: 배포 가이드
- VERIFICATION.md: 요구사항 검증 체크리스트
